---
import Layout from '../../layouts/Layout.astro';
import TypewriterText from '../../components/TypewriterText.astro';
import { getAllProjects } from '../../utils/data';

const projects = await getAllProjects();
---

<Layout title="Salty Architects - Projects">
  <div class="min-h-screen pt-[61px]">
    <div id="projects-container">
      <!-- Projects Table -->
      <div id="projects-table" class="projects-view">
        <!-- Fixed Header -->
        <div class=" border-t border-b border-[#3D3D3D]">
          <div class="grid px-5 h-[51px] items-start pt-[5px] font-normal" style="grid-template-columns: 1fr var(--col-size) var(--col-type) var(--col-year) var(--col-status) var(--col-arrow);">
            <div class="pl-0 whitespace-nowrap overflow-hidden text-ellipsis"></div>
            <div class="text-left whitespace-nowrap overflow-hidden text-ellipsis" style="width: var(--col-size);">
              <TypewriterText shortText="S" fullText="SIZE" />
            </div>
            <div class="text-left whitespace-nowrap overflow-hidden text-ellipsis" style="width: var(--col-type);">
              <TypewriterText shortText="T" fullText="TYPE" />
            </div>
            <div class="text-left whitespace-nowrap overflow-hidden text-ellipsis" style="width: var(--col-year);">
              <TypewriterText shortText="Y" fullText="YEAR" />
            </div>
            <div class="text-left whitespace-nowrap overflow-hidden text-ellipsis" style="width: var(--col-status);">
              <TypewriterText shortText="S" fullText="STATUS" />
            </div>
            <div class="whitespace-nowrap overflow-hidden text-ellipsis" style="width: var(--col-arrow);"></div>
          </div>
        </div>
        
        <!-- Scrollable Table Body -->
        <div class="overflow-y-auto h-[calc(100vh-112px)] pb-[50px]">
          {projects.map((project) => (
            <div 
              class="project-row cursor-pointer relative group transition-all duration-300 ease-in-out"
              data-slug={project.slug}
              data-project={JSON.stringify(project)}
            >
              <!-- Row Header -->
              <div class="grid px-5 h-[31px] items-center border-b border-[#3D3D3D]" style="grid-template-columns: 1fr var(--col-size) var(--col-type) var(--col-year) var(--col-status) var(--col-arrow);">
                <div class="pl-0 whitespace-nowrap overflow-hidden text-ellipsis">{project.title}</div>
                <div class="text-left whitespace-nowrap overflow-hidden text-ellipsis" style="width: var(--col-size);">{project.metadata.info}</div>
                <div class="text-left whitespace-nowrap overflow-hidden text-ellipsis" style="width: var(--col-type);">{project.metadata.category}</div>
                <div class="text-left whitespace-nowrap overflow-hidden text-ellipsis" style="width: var(--col-year);">{project.metadata.year}</div>
                <div class="text-left whitespace-nowrap overflow-hidden text-ellipsis" style="width: var(--col-status);">{project.metadata.status}</div>
                <div class="absolute right-[15px] flex items-center">
                  <img src="/assets/icons/project-arrow.svg" alt="" class="w-[14px] h-[11px] project-arrow" />
                  <img src="/assets/icons/project-x.svg" alt="" class="w-[14px] h-[14px] project-close hidden" />
                </div>
              </div>
              
              <!-- Expanded Content -->
              <div class="project-content hidden">
                <div class="relative w-full flex items-center justify-center" style="height: calc(100vh - 200px);">
                  <!-- Main Image -->
                  <div class="gallery-image-container relative" style="max-width: calc(100vw - 300px);">
                    <img class="gallery-image-1 absolute inset-0 max-w-full max-h-full m-auto transition-opacity duration-300" src="" alt="" />
                    <img class="gallery-image-2 absolute inset-0 max-w-full max-h-full m-auto opacity-0 transition-opacity duration-300" src="" alt="" />
                    
                    <!-- Navigation zones on the image -->
                    <div class="prev-zone absolute left-0 top-0 bottom-0 w-2/5 cursor-left"></div>
                    <div class="next-zone absolute right-0 top-0 bottom-0 w-2/5 cursor-right"></div>
                  </div>
                  
                  <!-- Bottom controls -->
                  <div class="absolute bottom-0 left-0 right-0 flex justify-between items-center p-5 text-sm">
                    <div class="image-counter text-[#3D3D3D]"></div>
                    <div class="next-project cursor-pointer hover:underline">Next Project â†’</div>
                  </div>
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>

    </div>
  </div>

  <!-- Hover Image Container -->
  <div id="hover-image-container" class="fixed pointer-events-none z-40 hidden">
    <img id="hover-image" src="" alt="" class="max-w-full h-auto" />
  </div>
 
  <style>
    :root {
      --col-size: 98px;
      --col-type: 138px;
      --col-year: 100px;
      --col-status: 158px;
      --col-arrow: 60px;
    }
    
    .projects-view {
      transition: opacity 0.3s ease-in-out;
    }
    
    .project-detail-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 40px;
      margin-top: 20px;
    }
    
    .project-images {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .project-image {
      width: 100%;
      height: auto;
    }
    
    .project-title {
      font-size: 32px;
      font-weight: 300;
      margin-bottom: 30px;
    }
    
    .project-metadata {
      display: flex;
      flex-direction: column;
      gap: 12px;
      font-size: 14px;
    }
    
    .label {
      font-weight: 500;
    }

    /* Hover state styles */
    .project-row {
      transition: opacity 0.2s ease-in-out;
    }
    
    .project-row.dimmed {
      opacity: 0.2;
    }
    
    .project-row:hover .grid {
      border-bottom: 1px solid rgba(61, 61, 61, 0.2);
    }
    
    /* Expanded row styles */
    .project-row.expanded {
      position: fixed;
      top: 61px;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 50;
      background: #E9E9E9;
      overflow-y: auto;
    }
    
    .project-row.expanded .project-content {
      display: block;
    }
    
    .project-row.expanded .project-arrow {
      display: none;
    }
    
    .project-row.expanded .project-close {
      display: block;
    }
    
    #hover-image-container {
      left: 415px;
      max-width: calc(100vw - 500px);
      opacity: 0;
      transition: opacity 0.15s ease-in-out;
    }
    
    #hover-image-container.show {
      opacity: 1;
    }
    
    /* Gallery styles */
    #project-detail {
      transition: opacity 0.15s ease-in-out;
    }
    
    #project-detail.show {
      opacity: 1;
    }
    
    .gallery-image-container {
      display: flex;
      align-items: center;
      justify-content: center;
      height: calc(100vh - 120px);
      width: 100%;
    }
    
    
    /* Cursor styles from homepage */
    .cursor-left {
      cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>') 12 12, auto;
    }
    
    .cursor-right {
      cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>') 12 12, auto;
    }
  </style>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const projectRows = document.querySelectorAll('.project-row');
      const hoverImageContainer = document.getElementById('hover-image-container');
      const hoverImage = document.getElementById('hover-image');
      const scrollContainer = document.querySelector('.overflow-y-auto');
      
      let currentHoverTimeout = null;
      
      // Helper functions
      function resetHoverStates() {
        projectRows.forEach(row => row.classList.remove('dimmed'));
        hideHoverImage();
      }
      
      function hideHoverImage() {
        hoverImageContainer.classList.remove('show');
        if (currentHoverTimeout) {
          clearTimeout(currentHoverTimeout);
        }
        currentHoverTimeout = setTimeout(() => {
          hoverImageContainer.classList.add('hidden');
          hoverImage.src = '';
          hoverImage.onload = null;
          hoverImage.onerror = null;
        }, 150);
      }
      
      function showHoverImage(projectData, rowElement) {
        // Clear any pending hide timeout
        if (currentHoverTimeout) {
          clearTimeout(currentHoverTimeout);
          currentHoverTimeout = null;
        }
        
        // Check if project has images
        if (!projectData.images || projectData.images.length === 0) {
          return;
        }
        
        // If image is currently showing, fade it out first
        if (hoverImageContainer.classList.contains('show')) {
          hoverImageContainer.classList.remove('show');
          setTimeout(() => {
            loadNewImage();
          }, 150); // Wait for fade out
        } else {
          loadNewImage();
        }
        
        function loadNewImage() {
          hoverImageContainer.classList.add('hidden');
          
          // Position the container
          const rowRect = rowElement.getBoundingClientRect();
          hoverImageContainer.style.top = `${rowRect.bottom + window.scrollY}px`;
          
          // Clear previous handlers
          hoverImage.onload = null;
          hoverImage.onerror = null;
          
          // Try local image first
          const localImagePath = `/data/projects/${projectData.slug}/image1.jpg`;
          const externalImage = projectData.images[0];
          
          let imageLoaded = false;
          
          // Set up load handler
          hoverImage.onload = function() {
            if (!imageLoaded) {
              imageLoaded = true;
              hoverImageContainer.classList.remove('hidden');
              requestAnimationFrame(() => {
                hoverImageContainer.classList.add('show');
              });
            }
          };
          
          // Set up error handler for local image
          hoverImage.onerror = function() {
            if (!imageLoaded && externalImage && externalImage.startsWith('http')) {
              // Try external image
              hoverImage.src = externalImage;
            }
          };
          
          // Clear and set new image
          hoverImage.src = '';
          setTimeout(() => {
            hoverImage.src = localImagePath;
          }, 10);
        }
      }
      
      // Event listeners
      scrollContainer.addEventListener('scroll', resetHoverStates);
      
      // Gallery state
      let currentProjectData = null;
      let currentImageIndex = 0;
      let allProjects = [];
      let currentProjectIndex = 0;
      
      // Initialize projects array
      projectRows.forEach((row, index) => {
        const projectData = JSON.parse(row.dataset.project);
        allProjects.push({ data: projectData, element: row, index });
      });
      
      // Gallery state for crossfade
      let activeGalleryImage = 1;
      
      // Gallery functions
      function openProjectDetail(projectData, rowElement, projectIndex) {
        currentProjectData = projectData;
        currentProjectIndex = projectIndex;
        currentImageIndex = 0;
        
        // Hide hover states
        resetHoverStates();
        
        // Disable scrolling when detail is open
        
        // Update header info
        document.getElementById('detail-title').textContent = projectData.title;
        document.getElementById('detail-size').textContent = projectData.metadata.info;
        document.getElementById('detail-type').textContent = projectData.metadata.category;
        document.getElementById('detail-year').textContent = projectData.metadata.year;
        document.getElementById('detail-status').textContent = projectData.metadata.status;
        
        // Show detail view
        const detailView = document.getElementById('project-detail');
        detailView.classList.remove('hidden');
        requestAnimationFrame(() => {
          detailView.classList.add('show');
        });
        
        // Load first image
        loadGalleryImage();
        
        // Update URL
        window.history.pushState({ slug: projectData.slug }, '', `/projects/${projectData.slug}`);
      }
      
      function closeProjectDetail() {
        const detailView = document.getElementById('project-detail');
        detailView.classList.remove('show');
        setTimeout(() => {
          detailView.classList.add('hidden');
          currentProjectData = null;
          currentImageIndex = 0;
          // Reset images
          document.getElementById('gallery-image-1').src = '';
          document.getElementById('gallery-image-2').src = '';
          document.getElementById('gallery-image-1').classList.remove('opacity-0');
          document.getElementById('gallery-image-2').classList.add('opacity-0');
          activeGalleryImage = 1;
        }, 150);
        
        // Reset URL
        window.history.pushState({}, '', '/projects');
      }
      
      function loadGalleryImage() {
        if (!currentProjectData || !currentProjectData.images || currentProjectData.images.length === 0) {
          return;
        }
        
        const nextImage = activeGalleryImage === 1 ? document.getElementById('gallery-image-2') : document.getElementById('gallery-image-1');
        const currentImage = activeGalleryImage === 1 ? document.getElementById('gallery-image-1') : document.getElementById('gallery-image-2');
        const imageCounter = document.getElementById('image-counter');
        
        // Update counter
        imageCounter.textContent = `${currentImageIndex + 1}/${currentProjectData.images.length}`;
        
        // Clear handlers
        nextImage.onload = null;
        nextImage.onerror = null;
        
        // Try local image first
        const localImagePath = `/data/projects/${currentProjectData.slug}/image${currentImageIndex + 1}.jpg`;
        const externalImage = currentProjectData.images[currentImageIndex];
        
        let imageLoaded = false;
        
        nextImage.onload = function() {
          if (!imageLoaded) {
            imageLoaded = true;
            // Crossfade
            nextImage.classList.remove('opacity-0');
            currentImage.classList.add('opacity-0');
            // Switch active image
            activeGalleryImage = activeGalleryImage === 1 ? 2 : 1;
          }
        };
        
        nextImage.onerror = function() {
          if (!imageLoaded && externalImage && externalImage.startsWith('http')) {
            nextImage.src = externalImage;
          }
        };
        
        // Set new image
        nextImage.src = localImagePath;
      }
      
      function navigateGallery(direction) {
        if (!currentProjectData || !currentProjectData.images) return;
        
        if (direction === 'next') {
          currentImageIndex = (currentImageIndex + 1) % currentProjectData.images.length;
        } else {
          currentImageIndex = (currentImageIndex - 1 + currentProjectData.images.length) % currentProjectData.images.length;
        }
        
        loadGalleryImage();
      }
      
      function goToNextProject() {
        const nextIndex = (currentProjectIndex + 1) % allProjects.length;
        const nextProject = allProjects[nextIndex];
        openProjectDetail(nextProject.data, nextProject.element, nextIndex);
      }
      
      // Event listeners
      projectRows.forEach((row, index) => {
        row.addEventListener('mouseenter', function() {
          // Don't show hover if detail is open
          if (currentProjectData) return;
          
          // Dim other rows
          projectRows.forEach(otherRow => {
            if (otherRow !== row) {
              otherRow.classList.add('dimmed');
            }
          });
          
          // Show hover image
          const projectData = JSON.parse(this.dataset.project);
          showHoverImage(projectData, this);
        });
        
        row.addEventListener('mouseleave', function() {
          if (!currentProjectData) {
            resetHoverStates();
          }
        });
        
        row.addEventListener('click', function() {
          const projectData = JSON.parse(this.dataset.project);
          // Only open if project has images
          if (projectData.images && projectData.images.length > 0) {
            openProjectDetail(projectData, this, index);
          }
        });
      });
      
      // Gallery navigation
      document.getElementById('close-detail').addEventListener('click', closeProjectDetail);
      document.getElementById('next-project').addEventListener('click', goToNextProject);
      
      document.getElementById('prev-zone').addEventListener('click', (e) => {
        e.stopPropagation();
        navigateGallery('prev');
      });
      
      document.getElementById('next-zone').addEventListener('click', (e) => {
        e.stopPropagation();
        navigateGallery('next');
      });
      
      // Keyboard navigation
      document.addEventListener('keydown', (e) => {
        if (!currentProjectData) return;
        
        if (e.key === 'ArrowLeft') {
          navigateGallery('prev');
        } else if (e.key === 'ArrowRight') {
          navigateGallery('next');
        } else if (e.key === 'Escape') {
          closeProjectDetail();
        }
      });
      
      // Handle browser back button
      window.addEventListener('popstate', (e) => {
        if (e.state && e.state.slug) {
          // Find project by slug and open it
          const project = allProjects.find(p => p.data.slug === e.state.slug);
          if (project) {
            openProjectDetail(project.data, project.element, project.index);
          }
        } else {
          closeProjectDetail();
        }
      });
      
      // Check if we should open a project on load
      const pathMatch = window.location.pathname.match(/^\/projects\/([^/]+)$/);
      if (pathMatch) {
        const slug = pathMatch[1];
        const project = allProjects.find(p => p.data.slug === slug);
        if (project) {
          setTimeout(() => {
            openProjectDetail(project.data, project.element, project.index);
          }, 100);
        }
      }
    });
  </script>
</Layout>